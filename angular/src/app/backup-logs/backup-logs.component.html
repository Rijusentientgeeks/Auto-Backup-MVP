<div class="card shadow-lg p-4 bg-white rounded">
  <div class="row mb-4">
    <div class="col">
      <h2 class="h4 fw-bold mb-0">Backup Logs</h2>
    </div>
  </div>
  <div class="row gy-3 gx-2 align-items-end filter-section">
    <!-- Backup Type Dropdown -->
    <div class="col-md-3 col-6">
      <div class="filter-group">
        <label for="backupType" class="form-label fw-bold filter-label"
          >Backup Type</label
        >
        <p-dropdown
          inputId="backupType"
          [(ngModel)]="selectedBackupType"
          (onChange)="onFilterChange()"
          [options]="backupTypes"
          optionLabel="name"
          optionValue="value"
          placeholder="Select Backup Type"
          [filter]="true"
          filterPlaceholder="Search..."
          class="filter-dropdown w-100"
        >
          <ng-template pTemplate="dropdownicon">
            <i class="pi pi-chevron-down"></i>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <!-- Storage Type Dropdown -->
    <div class="col-md-3 col-6">
      <div class="filter-group">
        <label for="storageType" class="form-label fw-bold filter-label"
          >Storage Type</label
        >
        <p-dropdown
          inputId="storageType"
          [(ngModel)]="selectedStorageType"
          (onChange)="onFilterChange()"
          [options]="storageTypes"
          optionLabel="name"
          optionValue="value"
          placeholder="Select Storage Type"
          [filter]="true"
          filterPlaceholder="Search..."
          class="filter-dropdown w-100"
        >
          <ng-template pTemplate="dropdownicon">
            <i class="pi pi-chevron-down"></i>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <!-- Cloud Storage Dropdown -->
    <div class="col-md-3 col-6">
      <div class="filter-group">
        <label for="cloudStorage" class="form-label fw-bold filter-label"
          >Cloud Storage</label
        >
        <p-dropdown
          inputId="cloudStorage"
          [(ngModel)]="selectedCloudStorage"
          (onChange)="onFilterChange()"
          [options]="cloudStorages"
          optionLabel="name"
          optionValue="value"
          placeholder="Select Cloud Storage"
          [filter]="true"
          filterPlaceholder="Search..."
          class="filter-dropdown w-100"
        >
          <ng-template pTemplate="dropdownicon">
            <i class="pi pi-chevron-down"></i>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <!-- Source Config Dropdown -->
    <div class="col-md-3 col-6">
      <div class="filter-group">
        <label for="sourceConfig" class="form-label fw-bold filter-label"
          >Source Config</label
        >
        <p-dropdown
          inputId="sourceConfig"
          [(ngModel)]="selectedSourceConfig"
          (onChange)="onFilterChange()"
          [options]="backupConfigs"
          optionLabel="backupName"
          optionValue="backUpStorageConfiguationId"
          placeholder="Select Configuration"
          [filter]="true"
          filterPlaceholder="Search..."
          class="filter-dropdown w-100"
        >
          <ng-template pTemplate="dropdownicon">
            <i class="pi pi-chevron-down"></i>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <!-- Keyword Search -->
    <div class="col-md-3 col-6">
      <div class="filter-group">
        <label for="keyword" class="form-label fw-bold filter-label"
          >Keyword</label
        >
        <span class="p-input-icon-left w-100">
          <i class="pi pi-search"></i>
          <input
            type="text"
            id="keyword"
            class="form-control filter-input"
            [(ngModel)]="keyword"
            (input)="onFilterChange()"
            placeholder="Search..."
          />
        </span>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <p-table
      [value]="backupLogs"
      [lazy]="true"
      [paginator]="true"
      [rows]="rows"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50]"
      [totalRecords]="totalRecords"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      (onLazyLoad)="loadBackupLogsLazy($event)"
      [loading]="loading"
      [scrollable]="true"
      scrollHeight="500px"
      styleClass="p-datatable-striped p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="sourceConfiguation.name">
            Source <p-sortIcon field="sourceConfiguation.name"></p-sortIcon>
          </th>
          <th pSortableColumn="startedTimeStamp">
            Started <p-sortIcon field="startedTimeStamp"></p-sortIcon>
          </th>
          <th pSortableColumn="completedTimeStamp">
            Completed <p-sortIcon field="completedTimeStamp"></p-sortIcon>
          </th>
          <th>Status</th>
          <th>File Name</th>
          <th>Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-log>
        <tr>
          <td>{{ log.sourceConfiguation?.backupName || "N/A" }}</td>
          <td>{{ log.startedTimeStamp | date : "yyyy-MM-dd HH:mm" }}</td>
          <td>{{ log.completedTimeStamp | date : "yyyy-MM-dd HH:mm" }}</td>
          <td>
            <p-tag
              [value]="
                log.backupLogStatus === 2
                  ? 'Success'
                  : log.backupLogStatus === 1
                  ? 'Failed'
                  : 'Aborted'
              "
              [severity]="
                log.backupLogStatus === 2
                  ? 'success'
                  : log.backupLogStatus === 1
                  ? 'danger'
                  : 'warning'
              "
            >
            </p-tag>
          </td>
          <td>{{ log.backUpFileName }}</td>
          <td>
            <!-- Show download button only if not downloading -->
            <button
              *ngIf="!downloadingIds.has(log.id)"
              pButton
              [disabled]="log.backupLogStatus !== 2"
              icon="pi pi-download"
              class="p-button-icon-only p-button rounded"
              (click)="downloadBackup(log)"
            ></button>
          
            <!-- Show spinner icon when downloading -->
            <div *ngIf="downloadingIds.has(log.id)" class="loading-overlay ml-2">
              <i class="pi pi-hourglass pi-spin" style="font-size: 1.5rem; color: gold"></i>
            </div>
          </td>
          
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-4 text-muted">
            <i class="pi pi-info-circle me-2"></i>No backup logs found
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
